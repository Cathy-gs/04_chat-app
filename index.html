<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>Firebase_version9_RealtimeDB(G'sACADEMYåˆå­¦è€…ç”¨ã‚µãƒ³ãƒ—ãƒ«)</title>
</head>
<body>

<!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºç”»é¢ -->

<div>
    <div> åå‰ï¼š<input type="text" id="uname"> </div>
    <div>
        <textarea id="text" cols="30" rows="10"></textarea>
        <button id="send">é€ä¿¡</button>
    </div>
    <div id="output" style="overflow: auto; height: 300px;"></div>
</div>
<!--/ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºç”»é¢ -->



<!-- JQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<!-- JQuery -->


<!--** ä»¥ä¸‹Firebase **-->

<!-- Firebaseã‹ã‚‰è²¼ã‚Šä»˜ã‘ -->
<script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    // ã“ã“ã«æ›¸ã„ãŸé–¢æ•°ã—ã‹ä½¿ãˆãªã„
    import { getDatabase, ref, push, set, update, onChildAdded, remove, onChildChanged, onChildRemoved  } 
    // é–¢æ•°ã®å‚ç…§å…ƒ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’åˆã‚ã›ã‚‹
    from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";
   
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries
  
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyA1he7xQoZcPyBcI9wYC5BZk9sK6y0nBo4",
      authDomain: "example-8a6aa.firebaseapp.com",
      projectId: "example-8a6aa",
      storageBucket: "example-8a6aa.appspot.com",
      messagingSenderId: "881670600379",
      appId: "1:881670600379:web:a6536c2bf6e66ec1719b9e"
    };
  
    // Initialize Firebase
    // FireBaseã«æ¥ç¶šã™ã‚‹
    const app = initializeApp(firebaseConfig);

    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ DBã«æ¥ç¶šã™ã‚‹
    const db = getDatabase(app);
    const dbRef = ref(db,"chat");
    // ->å¤šé‡æ§‹é€ ã«ï¼ˆéšå±¤åŒ–ï¼‰ã™ã‚‹éš›ã¯ã€chat/memo1/memo2ã®ã‚ˆã†ãªæ›¸ãæ–¹ã‚’ã™ã‚‹
 


    // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹
    $("#send").on("click",function(){
        const crrentTime = new Date().toString(); //ç¾åœ¨ã®æ™‚åˆ»ã‚’å–å¾—

        const msg = {
            // constã®ä¸­ã§constã¯å®£è¨€ã—ãªã„ã€‚ã¾ãŸã€ï¼ã‚‚ä½¿ã‚ãšï¼šã§ä»£å…¥ã‚’ã™ã‚‹ã€‚{}å†…ã§ã¯;ã‚’ä½¿ã†ã¨è¡Œæœ«ã«ãªã£ã¦ã—ã¾ã†ã®ã§ã€,ã«ã™ã‚‹
            uname : $("#uname").val(),
            text : $("#text").val(),
            timestamp : crrentTime // ç¾åœ¨ã®æ™‚åˆ»ã‚’ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«è¿½åŠ ã™ã‚‹
            // replies : [] //è¿”ä¿¡ç”¨ã®ç©ºã®é…åˆ—ã‚’è¿½åŠ ã™ã‚‹
        };
        // ãƒãƒ£ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã‚’Firebase Realtime Databaseã«ä¿å­˜ã™ã‚‹
        // ã©ã“ã«ãƒ‡ãƒ¼ã‚¿ã‚’å…¥ã‚ŒãŸã„ã®ã‹ â†’å¤‰æ•°dbRefã§ã€chatã«å…¥ã‚ŒãŸã„ 
        const newPostRef = push(dbRef); //Firebaseã®ä¸­ã«ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚­ãƒ¼ã‚’ç”Ÿæˆ(ç™ºè¡Œã•ã‚Œã‚‹) -> ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚­ãƒ¼ã‚’ç™ºè¡Œã—ãªã„å ´åˆã¯ã“ã®éƒ¨åˆ†ã‚’å‰Šé™¤ã™ã‚‹ãŒã€ã“ã‚ŒãŒãªã„ã¨æ¯å›ãƒ‡ãƒ¼ã‚¿ãŒã•ã‚Œã‚‹
        set(newPostRef,msg); // DBã«å€¤ã‚’ã‚»ãƒƒãƒˆã™ã‚‹ã€‚newPostRefã«msgã‚’æ ¼ç´ã™ã‚‹ â†’ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚­ãƒ¼ã‚’ç™ºè¡Œã—ãªã„å ´åˆã¯dbRefã‚’åˆ©ç”¨ã™ã‚‹ã¨ãƒ‡ãƒ¼ã‚¿ãŒå…¥ã‚‹
    });

    //å…¥åŠ›ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã™ã‚‹
    onChildAdded(dbRef,function(data){
        const msg = data.val();  //dbRefã§ãƒãƒ£ãƒƒãƒˆã‚’ç›£è¦–ã™ã‚‹ã€‚ã“ã“ã«ãƒ‡ãƒ¼ã‚¿ãŒå…¥ã£ã¦ããŸã‚‰ã€ãƒ‡ãƒ¼ã‚¿ã¨ã„ã†é–¢æ•°ã‚’msgã«ä»£å…¥ã™ã‚‹
        const key = data.key; // ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚­ãƒ¼ã‚’æŒã£ã¦ãã‚‹ å‰Šé™¤ãƒ»æ›´æ–°ã«å¿…é ˆ
        


        let h = '<div id = "'+key+'">';
            h += '<p>' + msg.uname + '</p>';
            h +='<br>';
            // h += '<p>' + msg.text + ": " + '</p>';
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç·¨é›†ç”¨ã®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¡¨ç¤º
            h += '<span contentEditable = "true" id = "'+key+'_update" > '+ msg.text +'</span>';

        // æ™‚åˆ»ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆåŒ–ã—ã¦è¡¨ç¤ºã™ã‚‹
        var timestamp = new Date(msg.timestamp);
        var formattedTime = timestamp.toLocaleString('ja-JP', { month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' });
            h += '<p>' +formattedTime +  '</p>';

            
            // h += '<span class = "remove" date-key = "'+key+'"> ğŸˆ</span>'
            // h += '<span class = "update" date-key = "'+key+'"> ğŸ¶</span>'
            // h += '</div>';
            
     

        
            // h += '<span contentEditable="true" id="' + key + '_update">' + msg.text + '</span>'; 
            
            // å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ã™ã‚‹
            h += '<button class = "remove" date-key = "'+key+'"> å‰Šé™¤</button>';

            // æ›´æ–°ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ã™ã‚‹
            h += '<button class = "update" date-key = "'+key+'"> æ›´æ–°</button>';

            // è¿”ä¿¡ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ã™ã‚‹
            h += '<button class="reply-btn" data-key="' + key + '">è¿”ä¿¡</button>';
            // è¿”ä¿¡ãƒ•ã‚©ãƒ¼ãƒ ã‚’éè¡¨ç¤ºã«ã™ã‚‹
            h += '<div class="reply-form" style="display: none;">'; 

        $("#output").prepend(h);
        });

            // // è¿”ä¿¡å†…å®¹ã‚’å…¥åŠ›ã™ã‚‹ãŸã‚ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’è¿½åŠ ã™ã‚‹
            // // è¿”ä¿¡å†…å®¹ã‚’å«ã‚€divã‚’è¿½åŠ 
            // h += '<div class="replies-container">'; 
            // // // è¿”ä¿¡å†…å®¹ã®è¡¨ç¤ºã™ã‚‹
            // msg.replies.forEach(function (reply){
            //     // è¿”ä¿¡å†…å®¹ã‚’è¡¨ç¤º
            //     h += '<p>' + reply.uname + ": " + reply.text + '</p>'; 
                
            // // ãƒãƒ£ãƒƒãƒˆå†…å®¹ã‚’è¡¨ç¤º   
           


            //     // replyã®æ™‚åˆ»ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆåŒ–ã—ã¦è¡¨ç¤ºã™ã‚‹
            //     var replyTimestamp = new Date(reply.timestamp);
            //     var formattedReplyTime = replyTimestamp.toLocaleString('ja-JP', { month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' });
            //     // è¿”ä¿¡ã—ãŸæ™‚åˆ»ã‚’è¡¨ç¤ºã™ã‚‹
            //     h += '<p>' + formattedReplyTime + '</p>'; 
            //     // å„è¿”ä¿¡ã®divã‚’é–‰ã˜ã‚‹
            //     h += '</div>';

            //     });
            // // è¿”ä¿¡ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‰ã˜ã‚‹
            // h += '</div>';

            //    // è¿”ä¿¡ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¿½åŠ 
            // h += '<input type="text" class="reply-input" placeholder="è¿”ä¿¡ã‚’å…¥åŠ›">';
            // h += '<button class="submit-reply-btn" data-key="' + key + '">è¿”ä¿¡ã‚’é€ä¿¡</button>';
            // h += '</div>'; // è¿”ä¿¡ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‰ã˜ã‚‹

            // h += '</div>'; // ãƒ¡ã‚¤ãƒ³ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’é–‰ã˜ã‚‹
         
        


           
       
           
        
 
   

    // å‰Šé™¤ã‚¤ãƒ™ãƒ³ãƒˆ
    $("#output").on("click", ".remove", function(){
        const key = $(this).attr("date-key");
        const remove_item = ref(db, "chat/"+key);
        remove(remove_item); //Firebaseãƒ‡ãƒ¼ã‚¿å‰Šé™¤é–¢æ•°
    });


    // æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆ
    $("#output").on("click", ".update", function(){
        const key = $(this).attr("date-key");
        update (ref(db, "chat/"+key),{
            text: $("#" + key + '_update').html()
        });
    });

    // å‰Šé™¤å‡¦ç†ãŒFirebaseå´ã§å®Ÿè¡Œã•ã‚ŒãŸã‚‰ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã™ã‚‹
    onChildRemoved(dbRef, (data) => {
        $("#"+ data.key).remove();
    });

    // å‰Šé™¤å‡¦ç†ãŒFirebaseå´ã§å®Ÿè¡Œã•ã‚ŒãŸã‚‰ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã™ã‚‹
    onChildChanged(dbRef, (data) => {
        $("#"+ data.key+'_update').html(data.val().text);
        $("#"+ data.key+'_update').fadeOut(800).fadeIn(800);
    });

    // "#send"ï¼ˆã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ï¼‰
  </script>











</body>
</html>



<!-- 
// ã“ã‚Œå®Ÿè£…ã—ãŸã„
https://qiita.com/taketakekaho/items/52b7c196ddbd4cb3c968 -->




























